<!--
 * @Author: Shu Binqi
 * @Date: 2023-03-01 07:34:58
 * @LastEditors: Shu Binqi
 * @LastEditTime: 2023-03-11 01:12:16
 * @Description: MongoDB面试题（44题）
 * @Version: 1.0.0
 * @FilePath: \interviewQuestions\前端框架\NodeJS\MongoDB.md
-->

#### 什么是 MongoDB？有什么优缺点？

MongoDB 是一个开源的面向文档的 NoSQL 数据库，它使用类似 JSON 的 BSON 格式来存储和处理数据，具有高度的灵活性、可扩展性和性能。

MongoDB 的优点包括：

1. **高度的灵活性**：MongoDB 使用文档存储数据，每个文档可以有不同的结构和字段，这使得 MongoDB 非常灵活，可以存储各种类型和格式的数据。
1. **高可扩展性**：MongoDB 具有良好的可扩展性，可以通过添加更多的节点来实现水平扩展，从而提高系统的容量和性能。
1. **高性能**：MongoDB 采用了内存映射技术和多线程处理等技术，从而提高数据的读写性能和查询速度。
1. **支持多种查询方式**：MongoDB 支持基于文档结构和内部字段的复杂查询，也支持 MapReduce、聚合框架等高级查询方式。
1. **可以存储大量的数据**：MongoDB 可以存储大量的数据，支持多种数据类型，包括文本、图片、视频等多种格式。

MongoDB 的缺点包括：

1. **不支持事务**：MongoDB 不支持事务，只支持单个文档级别的原子性操作，这使得它不适合用于需要多个文档之间的复杂事务的场景。
1. **存储空间的消耗**：MongoDB 使用 BSON 格式来存储数据，相比于其他数据格式，BSON 的存储空间消耗较大，这会增加存储成本。
1. **内存使用高**：MongoDB 的内存使用比较高，因为它使用内存映射技术来提高性能，这使得 MongoDB 在资源受限的环境下可能会出现性能问题。
1. **不适合关系型数据**：MongoDB 不适合存储关系型数据，因为它不支持 SQL 语言和关系型数据库的特性，如复杂的联结、约束和事务等。

总的来说，MongoDB 适合用于大规模的非结构化数据存储和处理场景，具有高度的灵活性、可扩展性和性能，但也存在一些缺点需要注意。

#### 什么是数据库？

数据库（Database）是一种用于存储、管理和操作大量数据的软件系统。它可以提供高效、可靠、安全和持久化的数据存储和访问服务，方便用户对数据进行查询、更新、删除、插入等操作。

数据库通常由两个主要组件组成：数据存储和数据管理。数据存储负责存储和检索数据，而数据管理则负责管理数据库的结构、安全性、并发性、备份和恢复等方面。数据库通过提供高效的数据存储和管理功能，可以支持各种类型的应用程序，包括网站、移动应用程序、企业应用程序等。

常见的数据库类型包括关系型数据库（如 MySQL、Oracle、SQL Server 等）、面向对象数据库（如 MongoDB、Couchbase 等）、键值对数据库（如 Redis、Memcached 等）等。不同类型的数据库具有不同的特点和适用场景，用户可以根据自己的需求来选择适合自己的数据库。

#### 什么是集合（表）？

集合（也称为表）是计算机科学中的一种数据结构，它是由一组元素组成的无序集合。集合中的元素通常是唯一的，重复的元素会被视为一个元素。

集合通常用于表示一组相关的数据，例如一组学生的成绩、一组用户的信息等等。集合可以支持添加、删除、查询等基本操作，也可以进行合并、交集、并集等复杂操作。在数据库、编程语言、算法等领域中，集合都是非常常见的数据结构。

在计算机科学中，常见的集合实现包括数组、链表、哈希表、树等。每种实现方式都有其优缺点，可以根据实际需求选择最合适的实现方式。

#### 什么是文档（记录）？

在计算机科学中，文档（也称为记录）是一种数据结构，用于表示一组相关的数据。与集合不同的是，文档中的每个元素都是由一个或多个字段（属性）组成的，每个字段都包含一个键和一个值，用于表示某个特定的数据。

例如，一份学生的信息文档可以包含多个字段，例如姓名、年龄、性别、出生日期等，每个字段的键代表该字段的名称，值代表该字段所对应的具体数据。

文档通常用于表示结构化数据，例如数据库中的一行记录、JSON 格式的数据等等。与集合类似，文档也支持添加、删除、查询等基本操作，同时也可以进行复杂的操作，例如更新、嵌套查询等。

在不同的计算机系统和编程语言中，文档的实现方式也不同，例如在关系型数据库中，文档通常以表的形式出现，每个表中的行代表一个文档；而在 NoSQL 数据库中，文档通常以 JSON 格式存储，每个文档包含多个字段和值。

#### 什么是非关系型数据库（NoSQL）？

非关系型数据库（NoSQL）是相对于关系型数据库而言的一种新型数据库技术，其数据结构不使用传统的表格形式，而是采用更加灵活的数据模型，例如键值对、文档、图形或者列族等等。

与关系型数据库不同，非关系型数据库通常不需要预定义数据模式和结构，可以动态适应数据结构的变化和扩展，因此适用于处理大量不规则、分散的数据，例如社交网络、物联网等应用场景。

非关系型数据库的优点包括：

1. **高可扩展性**：非关系型数据库可以方便地进行水平扩展，可以在不需要对整个系统进行重新设计的情况下，随着数据的增长而逐步增加节点数。
2. **高性能**：由于不需要进行复杂的表格关联查询，非关系型数据库通常具有更高的读写性能和响应速度。
3. **更好的数据结构适应性**：非关系型数据库的数据结构更加灵活，可以根据实际的数据模型进行设计，更好地适应数据的结构变化。
4. **支持分布式处理**：非关系型数据库通常具有分布式处理和并行计算能力，可以更好地处理大规模的数据集群。

常见的非关系型数据库包括 MongoDB、Cassandra、Redis、HBase 等等。

#### 为什么用 MOngoDB？

MongoDB 是一款广泛应用的 NoSQL 数据库，具有以下几个方面的优点：

1. **灵活的数据模型**：MongoDB 的数据模型采用的是文档型数据库的形式，具有较高的灵活性，可以轻松地应对数据模型的变化和扩展。MongoDB 的文档可以包含嵌套文档和数组等复杂的数据结构，使得数据可以更加丰富多样。
2. **高性能**：MongoDB 支持水平扩展，能够处理大量的并发请求，可以在多台服务器上分布存储数据和请求的负载，具有较高的读写性能和响应速度。
3. **丰富的功能特性**：MongoDB 支持多种数据类型、索引、地理空间查询、全文搜索等高级功能特性，同时支持 ACID 事务、数据复制、数据备份等稳定性和可靠性方面的功能。
4. **社区支持**：MongoDB 拥有一个庞大的社区支持，具有丰富的文档、教程和资源，可以轻松地进行学习和使用。
5. **应用广泛**：MongoDB 被广泛应用于 Web 应用、物联网、大数据分析等领域，具有良好的生态环境和工具支持。

综上所述，MongoDB 具有灵活的数据模型、高性能、丰富的功能特性、社区支持和广泛的应用场景等优点，因此在一些需要处理非结构化数据、需要快速响应和水平扩展等场景中，MongoDB 是一款优秀的数据库选择。

#### 在哪些场景使用 MongoDB？

MongoDB 作为一款流行的 NoSQL 数据库，适用于以下几个场景：

1. **处理大量非结构化数据**：MongoDB 的文档型数据模型可以处理非结构化数据，例如日志、图像、视频等数据类型，因此适用于处理大量非结构化数据的场景。
2. **高并发读写场景**：MongoDB 支持分布式架构，可以水平扩展，适合于高并发读写场景，例如 Web 应用、物联网、大数据分析等。
3. **数据存储和查询**：MongoDB 支持高效的数据存储和查询操作，支持复杂的数据类型和查询语句，可以应对需要频繁读取和查询数据的场景。
4. **实时数据处理**：MongoDB 可以快速地存储和处理实时数据，例如在线游戏、社交媒体等实时交互性的应用场景。
5. **大数据分析**：MongoDB 可以用于存储和分析大量的数据，支持地理空间查询、全文搜索、聚合操作等高级功能，适合于大数据分析和挖掘的场景。

总之，MongoDB 适用于需要处理非结构化数据、高并发读写、实时数据处理、大数据分析等场景，具有灵活的数据模型、高性能、丰富的功能特性和可扩展性等优点。

#### MongoDB 中的命名空间是什么意思？

在 MongoDB 中，命名空间（namespace）是指一个数据库中的集合或索引的命名方式。命名空间包含两部分：数据库名称和集合名称，中间用点号（.）分隔。

对于集合而言，命名空间就是数据库名称和集合名称的组合，例如 test.users 表示 test 数据库中的 users 集合。

对于索引而言，命名空间是指索引所属的集合和索引名称的组合，例如 test.users.username_1 表示 test 数据库中 users 集合的 username 字段上的 1 升序索引。

在 MongoDB 中，每个集合和索引都有其唯一的命名空间，用于标识其在数据库中的位置。MongoDB 使用命名空间来区分不同的集合和索引，并且将它们存储在一个专门的系统集合中（system.namespaces），方便管理和查询。

总之，MongoDB 中的命名空间是指集合或索引所属的数据库名称、集合名称和索引名称的组合，用于标识其在数据库中的位置。

#### MongoDB 中的分片什么意思？

在 MongoDB 中，分片（Sharding）是指将数据水平拆分到多台服务器上存储和管理的过程。当数据量增长到单个服务器无法处理时，使用分片可以将数据分布到多个服务器上，实现数据的横向扩展，提高数据的处理能力和性能。

在 MongoDB 的分片集群中，通常包含以下几个角色：

1. **路由器**（mongos）：作为应用程序和分片集群之间的中间件，接收来自客户端的请求，将请求路由到正确的分片上，并将结果返回给客户端。
1. **配置服务器**（config server）：存储整个分片集群的元数据信息，包括分片集群中的所有数据块（chunks）和分片键（shard key）等信息。
1. **分片服务器**（shard server）：存储实际的数据块，每个分片服务器都是独立的 MongoDB 实例，可以水平扩展，支持数据复制和故障转移。

在 MongoDB 中，可以按照指定的分片键将数据集合划分成多个均匀的数据块（chunks），每个数据块可以分配到不同的分片服务器上。当客户端发送查询请求时，路由器会根据查询条件和分片键，将查询请求路由到包含相关数据块的分片服务器上执行查询，然后将结果返回给客户端。

总之，MongoDB 中的分片是一种将数据分布到多台服务器上存储和管理的方法，可以水平扩展数据处理能力和性能。分片集群包括路由器、配置服务器和分片服务器三个角色，可以将数据划分成多个数据块并分配到不同的分片服务器上，实现数据的分布式存储和查询。

#### 为什么要在 MongoDB 中使用分析器？

在 MongoDB 中，查询分析器（query profiler）是一个非常有用的工具，可以帮助开发人员和管理员分析数据库的性能和查询效率，找出慢查询并进行优化。

具体来说，MongoDB 的查询分析器可以记录查询的详细信息，包括查询的执行时间、扫描的文档数、返回的文档数、使用的索引等，可以帮助开发人员深入了解查询的执行情况，找出执行时间过长、效率低下的查询，并进行针对性的优化。

在实际应用中，由于 MongoDB 是一种文档型数据库，数据结构和查询方式与传统的关系型数据库有很大的不同，需要特别注意查询的优化和调试。使用查询分析器可以帮助开发人员更好地理解和优化 MongoDB 的查询性能，提高应用程序的性能和用户体验。

总之，MongoDB 的查询分析器是一个非常有用的工具，可以帮助开发人员和管理员分析数据库的性能和查询效率，找出慢查询并进行优化，提高应用程序的性能和用户体验。

#### MongoDB 支持主键外键关系吗？

MongoDB 是一种非关系型数据库，和传统的关系型数据库相比，它不支持传统意义上的主键和外键的概念。

在 MongoDB 中，每个文档都有一个 \_id 属性，它是一个唯一的标识符，可以用来唯一标识一个文档。在某些情况下，可以将 \_id 属性作为主键使用，但是它并不是严格意义上的主键，因为它没有强制要求唯一性和非空性。

如果需要在 MongoDB 中实现类似于传统关系型数据库中主键和外键的功能，可以采用一些其他的方式，例如：

1. 在文档中嵌入其他文档的方式，实现类似于关系型数据库中的关联关系；
1. 在文档中使用其他字段作为主键，例如使用自增字段或者业务相关的字段作为主键；
1. 在应用程序中手动维护主键和外键的关系，例如通过程序来保证两个文档之间的关联关系。

需要注意的是，MongoDB 的非关系型特性决定了它的数据模型和查询语言与传统关系型数据库有很大的不同，因此需要开发人员在使用 MongoDB 时重新思考数据建模和查询优化的问题。

#### MongoDB 支持哪些数据类型？

MongoDB 支持多种数据类型，主要包括以下几种：

1. **字符串类型**（String）：存储字符串数据；
1. **数值类型**（Number）：支持整数和浮点数类型；
1. **布尔类型**（Boolean）：存储 true 或 false；
1. **数组类型**（Array）：存储一组有序的值；
1. **对象类型**（Object）：存储一组键值对；
1. **Null 类型**（Null）：存储空值；
1. **日期类型**（Date）：存储日期和时间；
1. **正则表达式类型**（Regular Expression）：存储正则表达式；
1. **二进制数据类型**（Binary Data）：存储二进制数据；
1. **ObjectID 类型**（Object ID）：存储文档的唯一标识符；
1. **时间戳类型**（Timestamp）：存储文档修改的时间戳；
1. **代码类型**（Code）：存储 JavaScript 代码；
1. **最大/最小键类型**（Max/Min Key）：用于比较键的大小。

需要注意的是，MongoDB 是一种动态模式的数据库，这意味着同一集合中的不同文档可以具有不同的字段和数据类型，可以根据具体的业务需求来灵活地进行数据建模和存储。

#### 为什么要在 MongoDB 中用"Code"数据类型？

在 MongoDB 中使用 "Code" 数据类型可以方便地存储 JavaScript 代码。这种类型常用于存储存储服务器端的 JavaScript 函数、聚合操作等。使用 "Code" 类型可以将代码存储在 MongoDB 中，便于以后查询、修改和复用。例如，可以将常用的聚合操作存储在数据库中，以便在多个地方重复使用，从而提高了代码的复用性和可维护性。

此外，在 MongoDB 中使用 "Code" 数据类型还可以方便地执行服务器端 JavaScript 代码，从而实现复杂的数据操作和计算。MongoDB 提供了 eval() 函数，用于在服务器端执行 JavaScript 代码，可以将 "Code" 类型的数据作为 eval() 函数的参数来实现自定义的数据操作和计算。但是需要注意，eval() 函数具有潜在的安全风险，应该谨慎使用。

#### 为什么要在 MongoDB 中用"Regular Expression"数据类型？

在 MongoDB 中使用 "Regular Expression"（正则表达式）数据类型可以方便地进行文本匹配和搜索操作。正则表达式是一种用于描述字符串匹配规则的语法，可以用于在文本中查找符合特定规则的字符串。MongoDB 支持在查询语句中使用正则表达式来进行模糊匹配和搜索，从而提高了数据的查询效率和灵活性。

正则表达式在 MongoDB 中通常用于匹配字符串字段，例如匹配电子邮件地址、电话号码、URL、IP 地址等等。使用正则表达式可以灵活地匹配不同的字符串格式，同时还支持一些特定的正则表达式操作，例如限定字符重复次数、选择多个匹配项、忽略大小写等等。此外，在 MongoDB 中还可以将正则表达式作为查询条件的一部分来实现更复杂的查询操作。

需要注意的是，使用正则表达式虽然可以提高查询的灵活性和效率，但也需要考虑性能和安全方面的问题。正则表达式的匹配操作通常比简单的字符串匹配要慢，特别是在数据量很大的情况下。同时，如果输入的正则表达式不正确或者恶意构造，还可能会导致安全问题。因此，在使用正则表达式时需要注意安全和性能方面的问题。

#### 为什么在 MongoDB 中使用"Object ID"数据类型？

在 MongoDB 中使用 "Object ID"（对象标识符）数据类型是因为它可以提供全局唯一的标识符来标识每个文档。每个文档都有一个唯一的 "\_id" 属性，可以用来在集合中查找和更新特定的文档。这种全局唯一的标识符可以避免在复杂的数据操作和分布式系统中出现重复数据或数据丢失的问题，同时还可以提高数据的查询效率。

MongoDB 中的 "\_id" 属性由 12 个字节组成，其中前 4 个字节表示时间戳，后 3 个字节表示机器标识符，2 个字节表示进程 ID，最后 3 个字节表示计数器。因此，每个 "\_id" 属性都是唯一的，并且可以按时间排序，从而提高了查询效率。

此外，在 MongoDB 中使用 "\_id" 属性还可以方便地进行集合分片和复制操作。集合分片是将数据分布到多个节点上，可以提高数据的处理能力和可扩展性。使用 "\_id" 属性作为分片键可以确保文档在不同节点上的分布均匀和查询效率。集合复制是将数据复制到多个节点上，可以提高数据的可靠性和容错性。使用 "\_id" 属性作为复制的唯一标识符可以确保文档在复制节点上的唯一性和一致性。

因此，在 MongoDB 中使用 "Object ID" 数据类型可以提高数据的唯一性、查询效率和可扩展性，是 MongoDB 数据库的一个重要特性。

#### "ObjectID"由哪些部分组成？

在 MongoDB 中，"ObjectID"（对象标识符）是一个 12 字节的 BSON 类型值，由以下三个部分组成：

1. **时间戳**（4 字节）：前面 4 个字节存储了一个从 1970 年 1 月 1 日 UTC 到现在的时间戳，单位是秒。这个时间戳可以保证 ObjectId 的全局唯一性，也可以按时间排序来查询数据。
1. **机器标识符**（3 字节）：接下来的 3 个字节存储了机器的标识符。这个标识符是根据机器的 MAC 地址或者其它机器唯一标识符生成的。如果有多个进程在同一个机器上运行，它们生成的 ObjectID 的前 8 个字节是相同的。
1. **进程 ID 和计数器**（5 字节）：最后的 5 个字节包括了一个进程标识符和一个计数器。进程标识符是 2 个字节，计数器是 3 个字节。当同一个进程需要生成多个 ObjectID 时，它会不断递增计数器来保证 ObjectID 的唯一性。

因此，ObjectId 可以通过时间戳、机器标识符、进程 ID 和计数器这四个部分来保证其在整个 MongoDB 集群中的唯一性，同时可以按时间排序来查询数据。

#### 在 MongoDb 中什么是索引？如何添加索引？

在 MongoDB 中，索引是一种特殊的数据结构，可以提高数据库的查询性能。它们允许我们在大型数据集中快速查找文档，而不必遍历整个集合。MongoDB 支持多种类型的索引，如单键索引、复合索引、全文索引等。

可以使用以下方法在 MongoDB 中添加索引：

1. 使用 createIndex()方法：createIndex()是 MongoDB 中的一个方法，用于在集合中创建一个索引。可以使用以下语法创建索引：

```
db.collection.createIndex({field: 1})
```

其中，db.collection 表示集合名称，field 表示要在其上创建索引的字段名称，1 表示索引的排序顺序。如果要按降序排序，可以使用-1 代替 1。

2. 使用 ensureIndex()方法：ensureIndex()是一个旧方法，在 MongoDB 3.0 及更高版本中已经被弃用。但是，在某些较旧的版本中，可能仍然需要使用它来创建索引。可以使用以下语法创建索引：

```
db.collection.ensureIndex({field: 1})
```

3. 使用 Index Management 功能：MongoDB 提供了一个 Index Management 功能，可以使用它来创建、修改和删除索引。可以通过 MongoDB Compass 等可视化工具来管理索引。
   需要注意的是，创建索引会占用一定的磁盘空间和内存，并且在写入文档时可能会影响性能。因此，在创建索引之前，需要根据实际需求和数据量进行评估，避免创建过多或不必要的索引。

#### 在 MongoDb 中什么是聚合？

在 MongoDB 中，聚合（Aggregation）是指在集合中对多个文档进行处理，从而返回计算结果的过程。聚合可以用于实现多种数据分析和统计操作，如计算平均值、求和、计数、分组等。

MongoDB 提供了一个聚合管道（Aggregation Pipeline）的概念，它允许用户使用一系列的聚合操作符（Aggregation Operators）来构建一个数据处理管道。聚合管道由多个阶段（Stage）组成，每个阶段都会对文档进行特定的处理操作，并将结果传递给下一个阶段。聚合管道的输出可以是单个文档、文档数组、嵌套文档等。

以下是一些常用的聚合操作符：

1. **$match**：用于筛选文档，类似于查询中的 where 语句；
1. **$group**：用于对文档进行分组，并对每个组进行聚合操作，如计算平均值、求和等；
1. **$project**：用于选择文档中的特定字段，并可以对字段进行重命名、计算等操作；
1. **$sort**：用于对文档进行排序操作，类似于查询中的 order by 语句；
1. **$skip**和$limit：用于分页操作，分别表示跳过前几个文档和返回文档数量的限制。

聚合操作可以使用 MongoDB 的命令行工具、驱动程序或可视化工具进行执行。例如，可以使用以下命令在 MongoDB 中执行一个简单的聚合操作：

```
db.collection.aggregate([
  { $match: { age: { $gt: 18 } } },
  { $group: { _id: "$gender", count: { $sum: 1 } } }
])
```

该聚合操作首先筛选出年龄大于 18 岁的文档，然后按照性别进行分组，并计算每个组中文档的数量。

#### 在 MongoDB 中什么是副本集？

在 MongoDB 中，副本集是一组 MongoDB 服务器的集合，其中包含一个主服务器和多个副本服务器。副本集提供了数据冗余和高可用性，以确保即使在主服务器故障的情况下，系统仍然可以继续工作。

在副本集中，所有写操作都在主服务器上执行，并自动复制到副本服务器。应用程序可以连接到任何一个副本服务器来读取数据，如果主服务器不可用，则自动切换到其中一个副本服务器。

副本集中的每个服务器都有一个角色：主服务器、副本服务器或仲裁服务器。主服务器负责处理所有写操作和一些读操作，副本服务器负责接收来自主服务器的数据复制，而仲裁服务器用于决定副本集中的主服务器。

副本集提供了自动故障检测和故障转移的功能，以确保即使出现故障也可以维护数据的可用性。

#### 什么是 NoSQL 数据库？NoSQL 和 RDBMS 有什么区别？在哪些情况下使用和不使用 NoSQL 数据库？

NoSQL（Not only SQL）数据库是指非关系型的数据库，相对于传统的关系型数据库（RDBMS），NoSQL 数据库更加灵活和可扩展，适用于大规模的分布式环境和高并发访问。

与 RDBMS 不同，NoSQL 数据库通常采用非结构化或半结构化的数据存储方式，不需要预先定义数据模式，可以根据实际应用场景动态地扩展和调整数据结构，支持海量数据的快速读写和查询。

NoSQL 数据库和 RDBMS 在以下方面有所不同：

1. **数据模型**：NoSQL 数据库通常采用键值对、文档、列族、图形等非关系型的数据模型，而 RDBMS 则采用关系模型。
1. **扩展性**：NoSQL 数据库通常更容易扩展，可以通过添加更多的节点来处理大量数据和高并发访问，而 RDBMS 则需要对表结构进行调整和优化。
1. **数据一致性**：NoSQL 数据库通常支持弱一致性和最终一致性，即在一定时间内可能存在数据不一致的情况，而 RDBMS 则通常保证强一致性。
1. **查询语言**：NoSQL 数据库通常具有自己独特的查询语言，而 RDBMS 则通常采用 SQL 查询语言。

在选择使用 NoSQL 数据库还是 RDBMS 数据库时，需要考虑以下因素：

1. **数据的类型和规模**：如果数据结构复杂，数据规模庞大，或需要高度可扩展性和高并发处理能力，则应该考虑使用 NoSQL 数据库。
1. **事务处理和数据一致性**：如果应用程序需要严格的事务处理和强一致性，则应该选择 RDBMS 数据库。
1. **数据查询和分析**：如果需要进行复杂的数据查询和分析，包括多表联合查询、数据聚合和数据分析等，则应该选择 RDBMS 数据库。
1. **开发效率和成本**：如果需要快速开发、部署和维护应用程序，并且在成本方面具有优势，则应该选择 NoSQL 数据库。

#### MongoDB 支持存储过程吗？如果支持的话，怎么用？

MongoDB 不支持像关系型数据库那样的存储过程。存储过程是预编译的一组 SQL 语句，可以用于多个应用程序和数据库操作，以便提高性能和安全性。与此不同，MongoDB 使用 JavaScript 函数代替存储过程。JavaScript 函数可以在 MongoDB 中定义和使用，以实现类似于存储过程的功能。在 MongoDB 中，可以使用 JavaScript 函数来执行各种操作，如插入，更新和删除文档，以及聚合操作等。

JavaScript 函数在 MongoDB 中通常存储在 system.js 集合中，可以通过 $where 运算符在查询中使用这些函数。例如，如果要使用名为 myFunction 的 JavaScript 函数来查找一个文档，可以使用以下查询：

```
db.myCollection.find({$where: "function() { return myFunction(this); }"})
```

在这里，myFunction 是一个定义在 system.js 中的 JavaScript 函数。由于 JavaScript 函数是动态编译的，因此需要在每个 MongoDB 实例上手动安装和定义这些函数。

#### 如何理解 MongoDB 中的 GridFS 机制，MongoDB 为何使用 GridFS 来存储文件？

MongoDB 使用 GridFS 机制来存储和管理大型文件（例如图像、视频、音频和文档等）。在 MongoDB 中，GridFS 使用两个集合（collections）来存储文件：fs.files 和 fs.chunks。

1. **fs.files** 集合存储文件的元数据信息，如文件名、文件大小、文件类型、上传日期等。
1. **fs.chunks** 集合存储文件数据，将文件划分为固定大小的块，每个块存储在一个文档中。如果文件大小小于块大小，则只有一个块。

MongoDB 使用 GridFS 来存储文件的主要原因是因为 MongoDB 的 BSON 文档大小有限制，一般为 16MB。如果要存储比 16MB 更大的文件，则必须使用 GridFS。GridFS 将大文件拆分成小块并将它们存储在多个文档中，从而解决了 BSON 文档大小限制的问题。

此外，GridFS 还具有其他优点，如可以通过 MongoDB 的复制和分片机制实现可伸缩性和容错性，以及可以使用 MongoDB 的查询和索引功能来快速查询和检索存储的文件。

总之，GridFS 是 MongoDB 用于存储和管理大型文件的机制，它将文件拆分成小块并将它们存储在多个文档中，解决了 BSON 文档大小限制的问题，并具有可伸缩性、容错性和查询功能等优点。

#### 为什么 MongoDB 的数据文件很大？

MongoDB 的数据文件之所以会很大，有以下几个原因：

1. **数据文件预分配空间较大**：MongoDB 为了避免频繁进行磁盘空间的分配和释放，会在文件创建时一次性预分配一定数量的空间，因此数据文件大小比实际数据量要大很多。
1. **内存映射机制**：MongoDB 使用内存映射机制（memory-mapped file），将数据文件映射到内存中，使得操作系统可以将磁盘 I/O 转换为内存操作，提高数据访问的速度。但是，这种方式也会导致数据文件的大小超过实际数据量。
1. **内部记录格式**：MongoDB 使用 BSON 格式来存储数据，相比于其他格式（如 JSON），BSON 更适合在 MongoDB 中进行存储和查询。但是，由于 BSON 格式需要更多的元数据，因此会导致数据文件更大。
1. **数据压缩**：MongoDB 支持对数据进行压缩，以节省存储空间。但是，压缩后的数据在读写时需要进行解压缩，会降低数据的访问速度。

需要注意的是，MongoDB 中的数据文件大小不一定是一个缺点，因为它可以提高数据读写的速度和性能。同时，MongoDB 也提供了多种方式来管理和优化数据文件的大小，如压缩、修剪等操作。

#### 当更新一个正在被迁移的块（Chunk）上的文档时会发生什么？

在 MongoDB 分片集群中，每个分片都会负责管理数据的一部分，数据被划分成多个块（Chunk），并按照特定的键值范围进行分配和迁移。当一个块正在迁移时，如果更新了该块上的文档，会发生以下情况：

1. 如果更新的文档不在正在迁移的块上，则更新操作不受影响。
1. 如果更新的文档在正在迁移的块上，且迁移目标分片已经确认接管了该块，则更新操作将在目标分片上执行，并将结果写入目标分片的本地副本。
1. 如果更新的文档在正在迁移的块上，但目标分片尚未确认接管该块，则更新操作将失败并返回一个错误，因为该块上的文档可能会在迁移完成前被移动到另一个分片上。

为了避免在迁移期间更新导致的问题，可以使用固定的分片键，确保在更新期间文档不会发生移动。同时，在迁移期间也可以暂停应用程序的写操作，以避免数据不一致。

#### MongoDB 在 A:{B,C} 上建立索引，查询 A:{B,C} 和 A:{C,B} 都会使用索引吗？

是的，MongoDB 在 A:{B,C} 上建立的索引可以用于查询 A:{B,C} 和 A:{C,B}，因为 MongoDB 会对索引字段进行排序，以确保索引能够正确地匹配查询条件。

#### MongoDB 成为最好 nosql 数据库的原因是什么？

MongoDB 成为最好的 NoSQL 数据库的原因主要有以下几点：

1. **强大的查询功能**：MongoDB 支持强大的查询功能，包括聚合框架、地理位置查询、文本搜索等功能，使得开发人员可以更加方便地进行数据分析和查询操作。
1. **灵活的数据模型**：MongoDB 的文档模型非常灵活，支持动态架构和嵌套数据模型，使得开发人员可以更加方便地存储和处理复杂的数据结构。
1. **分布式存储**：MongoDB 支持分布式存储，可以将数据分片存储在多个节点上，从而提高数据的可用性和可扩展性。
1. **高性能**：MongoDB 的数据存储方式采用了内存映射技术，可以实现高效的数据读写操作，并且支持多线程并发访问，使得数据库具有非常高的性能。
1. **社区支持**：MongoDB 有着活跃的社区支持，社区不断地为 MongoDB 提供更新版本和扩展功能，使得 MongoDB 在不断地发展和完善。

#### 如果用户移除对象的属性,该属性是否从存储层中删除？

在 MongoDB 中，如果用户从一个对象中移除属性，该属性实际上并没有从存储层中删除。相反，整个对象将被重新写入到磁盘上，但不包括已删除的属性。这是因为 MongoDB 使用动态模式，允许一个文档的结构随着时间的推移而发生变化，而不需要强制要求所有文档都具有相同的结构。这种方法使得应用程序可以更加灵活地使用 MongoDB，但也可能导致一些性能和存储问题，特别是在文档中有很多不同的属性时。因此，开发人员应该仔细考虑他们的数据模型和使用模式，以确保他们最大限度地利用了 MongoDB 的优势，并尽可能减少存储和性能方面的问题。

#### MongoDB 允许空值 null 吗？

是的，MongoDB 允许使用空值 null。在 MongoDB 中，null 表示空或缺少值，它可以在文档中的任何位置使用。可以将 null 用作单独字段的值，或者在数组和嵌入式文档中使用。当查询数据库时，可以使用 $exists 运算符来检查字段是否存在，并使用 $type 运算符来检查字段的类型是否为 null。

#### MongoDB 中更新操作立刻 fsync 到磁盘？

在 MongoDB 中，更新操作默认情况下不会立即 fsync 到磁盘，而是会将更新操作记录到操作日志中（oplog），并将操作日志写入磁盘。然后 MongoDB 会根据其自身的调度机制，将操作日志同步到磁盘上，以保证数据的持久性和一致性。

如果要在更新操作后立即将数据 fsync 到磁盘，可以使用 writeConcern 参数来指定写入数据的确认级别，例如将 writeConcern 设置为 majority 将会等待大多数节点确认写操作后再返回。但是，将写入确认级别设置为 majority 可能会影响 MongoDB 的写入性能，因此应该根据具体情况进行权衡。

#### 如何执行事务？

MongoDB 从版本 4.0 开始支持多文档事务。在 MongoDB 中，事务的概念类似于关系型数据库。事务是指将一组数据库操作绑定在一起，这些操作要么全部成功执行，要么全部回滚。事务提供了数据的一致性、可靠性和完整性保证。

要在 MongoDB 中执行事务，需要确保以下条件：

1. 数据库必须是副本集或者分片集群，不支持单个节点事务。
1. 数据库必须启用副本集写确认（write concern）。
1. 事务只支持读写操作，不支持管理命令（如创建或删除集合）。
1. 所有事务操作必须在同一个数据库中执行。

在 MongoDB 中使用事务需要使用 session 对象。通过 session 对象可以执行多个操作，并在最后进行提交或回滚。

#### 如何执行加锁？

在 MongoDB 中，事务和锁的概念是紧密相关的。MongoDB 使用乐观锁机制来支持事务并发执行。

在 MongoDB 4.0 及更高版本中，使用分布式事务（Distributed Transactions）来保证 ACID 属性。MongoDB 使用两个协议来实现分布式事务：一阶段提交和二阶段提交。在一阶段提交期间，事务协调器会协调参与事务的所有节点，进行事务的注册和准备工作；在二阶段提交期间，事务协调器会协调参与事务的所有节点，进行事务的提交或回滚。

在 MongoDB 4.2 及更高版本中，引入了多文档事务（Multi-Document Transactions）的概念，允许在一个或多个集合上执行事务。多文档事务遵循分布式事务的一阶段和二阶段提交协议，以保证 ACID 特性。

需要注意的是，在 MongoDB 中启用分布式事务或多文档事务会带来一定的性能开销，因此在实际应用中应根据实际需求和性能要求进行权衡。

#### MongoDB 启用备份故障恢复需要多久？

启用 MongoDB 备份和故障恢复需要的时间取决于多种因素，包括备份和故障恢复的类型、MongoDB 数据的大小和复杂性、所选备份和故障恢复方案的性能等。如果数据集很大，备份和恢复所需的时间可能会很长。此外，在备份和恢复过程中，可能需要停止正在运行的 MongoDB 实例，以便数据不会继续被修改，这可能会导致一些停机时间。因此，在启用备份和故障恢复之前，请务必仔细计划并进行充分测试，以确保系统的可靠性和可用性。

#### 什么是 master 或 primary？

在 MongoDB 中，副本集是一组托管同一数据集的 mongod 进程。每个副本集包含多个 mongod 节点，其中有一个主节点，也称为 primary 节点，其余的节点是从节点（secondary）。主节点是副本集中的活动节点，它接收所有写入操作并将更改同步到从节点。在 MongoDB 中，主节点通常是应用程序连接的节点。如果主节点发生故障，则从节点之一将被升级为主节点，以继续服务于应用程序的读写操作。

#### 分片（sharding）和复制（replication）是怎样工作的？

分片和复制是 MongoDB 中实现高可用性和横向扩展的两种机制。

复制是通过在多台服务器之间同步数据来提高可用性。在复制集中，一台服务器被称为主服务器（primary），负责处理所有的写请求，并将写操作同步到所有的备份服务器（secondary）中。在主服务器宕机的情况下，备份服务器之间会通过选举机制选出一个新的主服务器来接替原主服务器的工作，从而保证系统的可用性。

分片是通过将数据划分为多个分片（chunk）来实现横向扩展。在分片集群中，每个分片（chunk）存储部分数据，客户端在查询数据时，根据数据的分片键将查询请求路由到对应的分片（chunk）上，最后再将结果聚合返回给客户端。这样可以将查询负载分散到多个分片（chunk）上，提高系统的处理能力和性能。

复制和分片通常会结合使用，构建高可用性和高可扩展性的 MongoDB 集群。

#### 数据在什么时候才会扩展到多个分片（shard）里？

在 MongoDB 中，数据在写入到单个分片(shard)时，可能会因为该分片上的数据过多而达到容量极限。此时，需要将该分片的数据进行分割，并将其中一部分数据迁移到其他分片上。因此，当数据写入单个分片时，如果该分片的数据达到了预先设置的容量阈值，MongoDB 就会启动一个迁移过程，将该分片的一部分数据迁移到其他分片上。此时，数据就会扩展到多个分片中。

#### 当我试图更新一个正在被迁移的块（chunk）上的文档时会发生什么？

当您尝试更新正在迁移的块上的文档时，MongoDB 会将该块标记为“迁移中”。然后，MongoDB 将等待所有读取该块的操作完成，然后开始将该块从一个分片移动到另一个分片。此过程中，对于新写入的数据，MongoDB 会将其写入目标分片。但是，对于要更新的现有数据，MongoDB 会将更新操作复制到源分片和目标分片。当该块成功迁移到目标分片后，MongoDB 会将该块标记为“稳定的”并将更新操作应用到目标分片的副本中。最终，MongoDB 会将源分片中的块删除。

需要注意的是，当迁移块时，可能会出现网络故障或其他故障。在这种情况下，MongoDB 会尝试自动恢复迁移，或者您可以手动执行恢复操作。

#### 如果在一个分片（shard）停止或者很慢的时候，我发起一个查询会怎样？

如果一个分片（shard）停止工作或者变得很慢，MongoDB 查询会受到影响。具体来说，查询可能会非常缓慢或者完全失败。MongoDB 通过多种方式来减少这种情况的影响，例如通过副本集（replset）中的备份节点和分片集群（sharding cluster）中的多个分片（shard）来提高可用性。然而，如果一个分片（shard）不可用，查询将无法在该分片（shard）上执行，而且在查询时可能会出现错误，需要进行错误处理和重试。

#### 可以把 movechunk 目录里的旧文件删除吗？

在 MongoDB 的 moveChunk 目录中，旧的文件是可以删除的。这些文件是在迁移操作期间生成的临时文件，一旦迁移完成，它们就不再需要了。MongoDB 在迁移完成后会自动清理这些文件，但是如果需要，你也可以手动删除它们。请注意，删除这些文件不会影响你的数据，因为它们只是迁移期间使用的临时文件。

#### Mongodb 是否支持事务？

是的，MongoDB 自版本 4.0 以来支持多文档 ACID 事务，这是 MongoDB 的一个重要的改进和扩展。在分布式环境下，通过将多个写操作分组到一个事务中，可以保证这些写操作的一致性和原子性。事务可以跨越多个集合、多个文档和多个分片。
